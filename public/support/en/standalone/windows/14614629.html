
<div   class="support article"><h2>Обновление 1.3.0 -&gt; 1.4.x</h2><p class="auto-cursor-target"><br/></p><div class="alert alert-warning"><div class="rich-text"><p>Перед началом обновления необходимо выяснить версию лицензии вашего сервера. Если она 2016R1 её необходимо обновить до 2017 Сервер Сибрус версии 1.4.3 и новее работает только с лицензиями 2017</p></div></div><p>Запустите в консоли сервера программу <strong>cybrusadm</strong> указав в параметрах <strong>domain</strong> и <strong>dbname</strong> соответственно ваше имя базы данных и наименование домена Сибрус</p><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\cybrus\bin\cybrusadm --dbname cybrus_server --domain cybrus.sample  --operation print_server_license</div></div></div><p>В выводе программы найдите строку <strong>Valid for releases:</strong> или  <strong>Действительно для релизов:</strong> в ней будет указана версия лицензии. Если указана версия, отличная он 2017 Вам необходимо запросить у своего менеджера новую лицензию.</p><p>После получения файла новой лицензии, её необходимо активировать.</p><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\cybrus\bin\cybrusadm --dbname cybrus_server --domain cybrus.sample -o activate_license --license-file cybrus_license_ххххххх.dat</div></div></div><p>После этого Вы можете приступить к обновлению сервера</p><h4>1. Остановите сервисы Сибрус</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">net stop CybrusConfig</div><div class="line">net stop CybrusRelay</div><div class="line">net stop CybrusServer</div></div></div><h4>2. Обязательно сделайте резервную копию базы данных</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\cybrus\mongo\mongodump --host 127.0.0.1 --port 27017 --db cybrus_server --out c:\cybrus\mongo\backup01\</div></div></div><p>бекап запишется в текущую папку в c:\cybrus\mongo\backup01\</p><h4>3. Обновите сервер Сибрус</h4><p>перезаписав содержимое папок c:\cybrus\server\bin\ и c:\cybrus\server\locale соответствующим содержимым архива с новым дистрибутивом</p><h4>4. Обновите структуру базы данных</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\cybrus\server\bin\cybrus-server.exe --upgrade-to-collection-map -c c:\cybrus\server\config\server.config </div></div></div><h4>5. Обновите базу и индексы базы данных</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\cybrus\server\bin\cybrus-database-adm.exe --dbname cybrus_server --domain cybrus.sample --mongo-uri 127.0.0.1:27017 -o database-upgrade</div><div class="line">c:\cybrus\server\bin\cybrus-database-adm.exe --dbname cybrus_server --domain cybrus.sample --mongo-uri 127.0.0.1:27017 --drop-indexes -o indexes-create </div></div></div><h4>6. Запустите сервисы Сибрус</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">net start CybrusServer</div><div class="line">net start CybrusRelay</div><div class="line">net start CybrusConfig</div></div></div><h4>Если при выполнении п.5 происходит ошибка при удалении индексов:</h4><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\&gt;c:\cybrus\server\bin\cybrus-database-adm --dbname cybrus_server --domain cybrus.sample --mongo-uri 127.0.0.1:27017 --drop-indexes -o indexes-create </div><div class="line">исключение mogno: 10007 dropIndex failed </div><div class="line">terminate called after throwing an instance of 'mongo::DBException' </div><div class="line">what(): dropIndex failed </div><div class="line">Аварийный останов </div><div class="line">c:\&gt;</div></div></div><p>нужно подключиться консолью монги к базе данных и выполнить удаление индексов вручную </p><div class="code panel pdl"><div class="codeContent panelContent pdl"><div class="line">c:\&gt;c:\cybrus\mongo\bin\mongo cybrus_server </div><div class="line">&gt; db.getCollectionNames().forEach(function (d) { db[d].dropIndexes(); }); </div><div class="line">&gt; quit </div><div class="line">c:\&gt;</div></div></div><p class="auto-cursor-target"><br/></p></div>
